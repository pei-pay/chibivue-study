import type { Plugin } from 'vite';
import { createFilter } from 'vite';
import { parse } from '../../compiler-sfc';
import { compile } from '../../compiler-dom';

export default function vitePluginChibivue(): Plugin {
  const filter = createFilter(/\.vue$/);

  return {
    name: 'vite:chibivue',

    transform(code, id) {
      if (!filter(id)) return;

      const outputs = [];
      outputs.push("import * as ChibiVue from 'chibivue'\n");

      const { descriptor } = parse(code, { filename: id });
      const templateCode = compile(descriptor.template?.content ?? '', {
        isBrowser: false,
      });
      outputs.push(templateCode);

      outputs.push('\n');
      outputs.push(`export default { render }`);

      return { code: outputs.join('\n') };
    },
  };
}